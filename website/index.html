<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenVine</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="main.css?v=1">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta name="description" content="Watch and share 6-second looping videos">
    <style>
        /* Search Results Overlay */
        .search-results-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.9) !important;
            z-index: 9999 !important;
            overflow-y: auto;
        }
        
        .search-results-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }
        
        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .search-header h2 {
            color: white;
            font-family: 'Pacifico', cursive;
            font-size: 2rem;
            margin: 0;
        }
        
        .close-search {
            background: none;
            border: none;
            color: white;
            font-size: 40px;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-search:hover {
            color: #ff6b6b;
        }
        
        .search-status {
            color: white;
            text-align: center;
            font-size: 18px;
            margin: 20px 0;
            min-height: 25px;
        }
        
        .search-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .search-video-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        
        .search-video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .search-video-thumbnail {
            width: 100%;
            height: 200px;
            background: #f0f0f0;
            position: relative;
            overflow: hidden;
        }
        
        .search-video-thumbnail video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .search-video-info {
            padding: 15px;
        }
        
        .search-video-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .search-video-author {
            color: #666;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .search-video-stats {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #999;
        }
        
        .search-section {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .search-section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        /* Loading Animation */
        .search-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: white;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #00bf8f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            text-align: center;
        }
        
        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        /* Search box pulse animation when searching */
        .vine-search-input.searching {
            animation: searchPulse 2s ease-in-out infinite;
            border: 2px solid #00bf8f !important;
            box-shadow: 0 0 10px rgba(0, 191, 143, 0.5) !important;
        }
        
        @keyframes searchPulse {
            0%, 100% { box-shadow: 0 0 5px rgba(0, 191, 143, 0.3); }
            50% { box-shadow: 0 0 20px rgba(0, 191, 143, 0.6); }
        }
        
        /* Active category styling */
        .vine-category-item.active {
            background: #00bf8f !important;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0, 191, 143, 0.5);
        }
        
        /* Trending badge styling */
        .trending-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .vine-grid-item.trending {
            border: 2px solid #ff6b6b;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
        }
    </style>
    
    <!-- nostr-tools (Modern ESM import) -->
    <script type="module">
        // Load nostr-tools using modern ESM import
        try {
            const NostrTools = await import("https://esm.sh/nostr-tools@2.7.0");
            const { SimplePool } = await import("https://esm.sh/nostr-tools@2.7.0/pool");
            
            console.log('‚úÖ Loaded modern nostr-tools');
            console.log('NostrTools:', NostrTools);
            console.log('SimplePool:', SimplePool);
            
            // Make available globally for our scripts
            window.NostrTools = NostrTools;
            window.NostrPool = SimplePool;
            
        } catch (error) {
            console.error('‚ùå Failed to load nostr-tools:', error);
            console.log('üîÑ Will use WebSocket fallback');
        }
    </script>
</head>
<body>
    <!-- Header -->
    <header class="vine-header">
        <div class="vine-header-bg"></div>
        <div class="vine-header-content">
            <a href="/" class="vine-logo">OpenVine</a>
            <div class="vine-auth-buttons">
                <a href="https://app.openvine.co" class="vine-auth-btn vine-login-btn">Log in</a>
            </div>
        </div>
        <div class="vine-hero-section">
            <h1 class="vine-tagline">Return to a world of beautiful, looping videos.</h1>
            <div class="vine-search-container">
                <input type="text" class="vine-search-input" placeholder="Search" id="vineSearchInput" onkeypress="if(event.key==='Enter')searchVinesWithOverlay()">
            </div>
            <div class="vine-app-buttons">
                <a href="/ios" class="vine-app-btn vine-ios-btn">
                    <span class="vine-app-icon">üçé</span>
                    <span>Get it on<br><strong>iOS</strong></span>
                </a>
                <a href="open-source.html" class="vine-app-btn vine-android-btn">
                    <span class="vine-app-icon">ü§ñ</span>
                    <span>Get it on<br><strong>Android</strong></span>
                </a>
                <a href="open-source.html" class="vine-app-btn vine-windows-btn">
                    <span class="vine-app-icon">ü™ü</span>
                    <span>Get it on<br><strong>Windows</strong></span>
                </a>
                <a href="/macos" class="vine-app-btn vine-mac-btn">
                    <span class="vine-app-icon">üíª</span>
                    <span>Get it for<br><strong>macOS</strong></span>
                </a>
                <a href="open-source.html" class="vine-app-btn vine-linux-btn">
                    <span class="vine-app-icon">üêß</span>
                    <span>Get it on<br><strong>Linux</strong></span>
                </a>
            </div>
        </div>
    </header>

    <!-- Search Results Container -->
    <div id="searchResultsContainer" class="search-results-overlay" style="display: none;">
        <div class="search-results-content">
            <div class="search-header">
                <h2 id="searchResultsTitle">Search Results</h2>
                <button class="close-search" onclick="hideSearchResults()">&times;</button>
            </div>
            <div id="searchStatus" class="search-status"></div>
            <div id="searchResultsContent"></div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="vine-main-container">
        <!-- Left Sidebar - Categories -->
        <aside class="vine-sidebar-left">
            <div class="vine-categories">
                <h3>Channels</h3>
                <div class="vine-category-grid">
                    <!-- Row 1 -->
                    <div class="vine-category-item" onclick="showPlaylist('editors-picks')" title="Editor's Picks">üìπ</div>
                    <div class="vine-category-item" onclick="showRisingVideos()" title="Rising Videos">üöÄ</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('comedy')" title="Comedy">üòÇ</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('cool')" title="Cool">üòé</div>
                    
                    <!-- Row 2 -->
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('girls')" title="Girls">üëß</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('guys')" title="Guys">üßî</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('gaming')" title="Gaming">üéÆ</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('popnow')" title="Pop Now">üí•</div>
                    
                    <!-- Row 3 -->
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('musicdance')" title="Music & Dance">üéµ</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('ideas')" title="Ideas">üí°</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('trending')" title="Trending">üìä</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('special')" title="Special">‚ö°</div>
                    
                    <!-- Row 4 -->
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('animals')" title="Animals">ü¶ä</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('places')" title="Places & Travel">üó∫Ô∏è</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('family')" title="Family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('artdesign')" title="Art & Design">üé®</div>
                    
                    <!-- Row 5 -->
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('scary')" title="Scary">üíÄ</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('sports')" title="Sports">üèÉ</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('cars')" title="Cars">üöó</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('food')" title="Food">üçî</div>
                    
                    <!-- Row 6 -->
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('diy')" title="DIY">üî®</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('news')" title="News & Politics">üì±</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('fashion')" title="Fashion & Beauty">üíÑ</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('nature')" title="Nature">üèîÔ∏è</div>
                </div>
            </div>
            
            <!-- Editor's Pick -->
            <!-- <div class="vine-editors-pick">
                <h3>Editor's Pick</h3>
                <div class="vine-editors-video" id="editorsPickVideo">
                </div>
            </div> -->
            
            <!-- About OpenVine -->
            <div class="vine-about-section">
                <h3>Welcome back</h3>
                <p>OpenVine brings back 6-second looping videos. No algorithms. No filters. Just pure, authentic creativity.</p>
                <a href="about.html" class="vine-about-link">Our story ‚Üí</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="vine-main-content">
            <!-- Video Feed Container -->
            <div class="vine-video-feed" id="vineVideoFeed">
                <!-- Videos will be dynamically loaded here -->
            </div>
        </main>
    </div>

    <script>
        // Analytics API Constants  
        const ANALYTICS_API = 'https://api.openvine.co/analytics';
        
        // Dynamic Nostr content system
        let allNostrVideos = [];      // All videos from Nostr
        let allNostrProfiles = [];    // All profiles from Nostr  
        let allNostrPlaylists = [];   // All playlists from Nostr
        let videoCategories = new Set(); // Dynamic categories from hashtags
        let isContentLoaded = false;
        let contentSubscription = null;
        
        // Load manifest data
        // Load all content dynamically from Nostr
        async function loadNostrContent() {
            console.log('üöÄ Loading all content from Nostr...');
            
            try {
                // Initialize relay if needed
                const relayInstance = await initializeNostrRelay();
                if (!relayInstance) {
                    throw new Error('Failed to initialize nostr-tools relay');
                }

                console.log('‚úÖ Connected! Loading videos, profiles, and playlists...');

                // Close any existing subscription
                if (contentSubscription) {
                    contentSubscription.unsub();
                }

                // Create comprehensive filter for all content
                // For main feed, focus on specific user's vines
                // This is the main OpenVine content curator account
                const targetPubkey = '2d6a0f27043055948f4e2d0ff203d0112138ffd394b2a1c94f9da1d6d97f6911';
                
                const filter = {
                    kinds: [0, 22, 30023], // Profiles, Videos, Playlists
                    authors: [targetPubkey], // Load from specific user
                    limit: 1000,
                    since: Math.floor(Date.now() / 1000) - (365 * 24 * 60 * 60) // Last year to get all content
                };

                console.log('üì§ Creating subscription for all content types...');

                let eventCount = 0;
                let videoCount = 0;
                let profileCount = 0;
                let playlistCount = 0;

                // Create subscription
                contentSubscription = relayInstance.sub([filter]);

                // Handle events
                contentSubscription.on('event', (event) => {
                    eventCount++;
                    
                    if (event.kind === 0) { // Profile
                        profileCount++;
                        const profile = processNostrProfile(event);
                        if (profile && !allNostrProfiles.find(p => p.pubkey === profile.pubkey)) {
                            allNostrProfiles.push(profile);
                        }
                    } else if (event.kind === 22) { // Video
                        videoCount++;
                        const video = processNostrVideo(event);
                        if (video && !allNostrVideos.find(v => v.url === video.url)) {
                            allNostrVideos.push(video);
                            
                            // Extract categories from hashtags
                            if (video.hashtags && video.hashtags.length > 0) {
                                video.hashtags.forEach(tag => videoCategories.add(tag));
                            }
                        }
                    } else if (event.kind === 30023) { // Playlist
                        playlistCount++;
                        const playlist = processNostrPlaylist(event);
                        if (playlist && !allNostrPlaylists.find(p => p.id === playlist.id)) {
                            allNostrPlaylists.push(playlist);
                        }
                    }
                    
                    // Update UI periodically as content loads
                    if (eventCount % 50 === 0) {
                        console.log(`üìä Processed ${eventCount} events: ${videoCount} videos, ${profileCount} profiles, ${playlistCount} playlists`);
                        updateHomepageContent();
                    }
                });

                // Handle end of events
                contentSubscription.on('eose', () => {
                    console.log(`‚úÖ Content loading complete!`);
                    console.log(`üìä Final stats: ${videoCount} videos, ${profileCount} profiles, ${playlistCount} playlists`);
                    console.log(`üè∑Ô∏è Categories found: ${Array.from(videoCategories).join(', ')}`);
                    
                    isContentLoaded = true;
                    updateHomepageContent();
                    loadVideoFeed();
                    loadFromVineIntegration();
                });

                // Set timeout as fallback
                setTimeout(() => {
                    if (contentSubscription) {
                        console.log('‚è∞ Content loading timeout reached');
                        contentSubscription.unsub();
                        isContentLoaded = true;
                        updateHomepageContent();
                        loadVideoFeed();
                        loadFromVineIntegration();
                    }
                }, 15000);

            } catch (error) {
                console.error('‚ùå Error loading Nostr content:', error);
                // Fallback to empty state
                isContentLoaded = true;
                updateHomepageContent();
                loadVideoFeed();
            }
        }

        // Process Nostr profile event
        function processNostrProfile(event) {
            try {
                const profile = JSON.parse(event.content);
                return {
                    pubkey: event.pubkey,
                    name: profile.name || profile.display_name || `user_${event.pubkey.slice(0, 8)}`,
                    about: profile.about || '',
                    picture: profile.picture || '',
                    nip05: profile.nip05 || '',
                    created_at: event.created_at
                };
            } catch (e) {
                console.error('Error parsing profile:', e);
                return null;
            }
        }

        // Process Nostr video event  
        function processNostrVideo(event) {
            try {
                let videoUrl = '';
                let thumbnailUrl = '';
                let hashtags = [];
                
                // Extract URLs and hashtags from tags
                for (const tag of event.tags || []) {
                    if (tag[0] === 'r' && tag[1]) {
                        if (tag[2] === 'video') {
                            videoUrl = tag[1];
                        } else if (tag[2] === 'thumbnail') {
                            thumbnailUrl = tag[1];
                        } else if (!videoUrl && !tag[2]) {
                            videoUrl = tag[1];
                        }
                    } else if (tag[0] === 't' && tag[1]) {
                        hashtags.push(tag[1].toLowerCase());
                    }
                }

                if (!videoUrl) return null;

                // Find profile for this creator
                const creatorProfile = allNostrProfiles.find(p => p.pubkey === event.pubkey);
                const username = creatorProfile ? creatorProfile.name : `creator_${event.pubkey.slice(0, 8)}`;

                // Determine category from hashtags
                const category = getCategoryFromHashtags(hashtags);
                
                return {
                    id: event.id,
                    url: videoUrl,
                    thumbnail: thumbnailUrl || videoUrl.replace('/media/', '/media/thumb_'),
                    username: username,
                    title: event.content || 'Classic Vine',
                    avatar: getCategoryEmoji(category),
                    likes: 0, // Real counts would need to be fetched from reaction events
                    comments: 0, // Real counts would need to be fetched from reply events
                    reposts: 0, // Real counts would need to be fetched from repost events
                    loops: 0, // Views aren't tracked in Nostr
                    category: category,
                    hashtags: hashtags,
                    pubkey: event.pubkey,
                    created_at: event.created_at
                };
            } catch (error) {
                console.error('Error processing video event:', error);
                return null;
            }
        }

        // Process Nostr playlist event
        function processNostrPlaylist(event) {
            try {
                const playlist = JSON.parse(event.content);
                return {
                    id: event.id,
                    pubkey: event.pubkey,
                    name: playlist.name || 'Untitled Playlist',
                    description: playlist.description || '',
                    created_at: event.created_at
                };
            } catch (e) {
                console.error('Error parsing playlist:', e);
                return null;
            }
        }

        // Get category from hashtags
        function getCategoryFromHashtags(hashtags) {
            if (!hashtags || hashtags.length === 0) return 'general';
            
            const categoryMap = {
                'comedy': 'comedy',
                'funny': 'comedy', 
                'gaming': 'gaming',
                'games': 'gaming',
                'roblox': 'gaming',
                'music': 'music',
                'dance': 'music',
                'animals': 'animals',
                'pets': 'animals',
                'sports': 'sports',
                'fitness': 'sports',
                'cool': 'cool',
                'awesome': 'cool',
                'art': 'ideas',
                'diy': 'ideas',
                'special': 'special'
            };

            for (const tag of hashtags) {
                if (categoryMap[tag]) {
                    return categoryMap[tag];
                }
            }
            
            return hashtags[0] || 'general';
        }

        // Get category emoji based on name
        function getCategoryEmoji(categoryName) {
            const categoryEmojis = {
                'comedy': 'üòÇ',
                'gaming': 'üéÆ',
                'animals': 'ü¶ä',
                'sports': 'üèÉ',
                'music': 'üéµ',
                'cool': 'üòé',
                'ideas': 'üí°',
                'special': '‚ö°',
                'general': 'üé¨'
            };
            return categoryEmojis[categoryName] || 'üé¨';
        }

        // Update homepage content based on loaded Nostr data
        function updateHomepageContent() {
            if (allNostrVideos.length > 0) {
                currentVideos = shuffleArray([...allNostrVideos]);
                featuredVideoIndex = 0;
                console.log(`üîÑ Updated homepage with ${currentVideos.length} videos from Nostr`);
                
                // Update featured users section
                loadFeaturedViners();
            }
        }

        // Load fallback content (now empty since we rely on Nostr)
        function loadFallbackVideos() {
            console.log('‚ö†Ô∏è No Nostr content available, showing empty state');
            currentVideos = [];
            featuredVideoIndex = 0;
        }
        // Featured users will be dynamically generated from Nostr profiles
        function getFeaturedUsers() {
            if (allNostrProfiles.length === 0) return [];
            
            // Get top users by video count and engagement
            const userStats = {};
            
            allNostrVideos.forEach(video => {
                if (!userStats[video.pubkey]) {
                    userStats[video.pubkey] = {
                        username: video.username,
                        avatar: video.avatar,
                        videoCount: 0,
                        totalLikes: 0,
                        totalViews: 0
                    };
                }
                userStats[video.pubkey].videoCount++;
                // Engagement metrics hidden until real data available
                // userStats[video.pubkey].totalLikes += video.likes || 0;
                // userStats[video.pubkey].totalViews += video.loops || 0;
            });
            
            // Sort by video count since engagement metrics are hidden
            return Object.values(userStats)
                .sort((a, b) => b.videoCount - a.videoCount)
                .slice(0, 5)
                .map(user => ({
                    username: user.username,
                    avatar: user.avatar,
                    followers: `${Math.floor(user.totalViews / 1000)}K` // Estimate based on views
                }));
        }

        // Shuffle array function
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // State
        let currentVideos = []; // Will be loaded from manifest
        let featuredVideoIndex = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load all content dynamically from Nostr
            loadNostrContent();
        });

        // Setup audio controls
        function setupAudioControls() {
            const unmuteOverlay = document.getElementById('vineUnmuteOverlay');
            const player = document.getElementById('vineFeaturedPlayer');
            
            if (unmuteOverlay && player) {
                unmuteOverlay.addEventListener('click', () => {
                    isMuted = false;
                    player.muted = false;
                    unmuteOverlay.style.display = 'none';
                    player.play();
                });

                // Hide controls after interaction
                player.controls = false;
                
                // Show unmute overlay initially
                if (isMuted) {
                    unmuteOverlay.style.display = 'flex';
                }
            }
        }

        // Global mute state
        let isMuted = true;

        // Calculate time ago from timestamp
        function getTimeAgo(timestamp) {
            // These are archived vines from 2013-2017 era
            // Let's show realistic years ago
            const yearsAgo = Math.floor(Math.random() * 4) + 8; // 8-11 years ago (2013-2016)
            return `${yearsAgo} years ago`;
        }

        // Load featured video (for main playlist player)
        function loadFeaturedVideo() {
            loadPlaylistVideo(); // Use the existing playlist video function
        }

        // Load video feed
        function loadVideoFeed() {
            const feed = document.getElementById('vineVideoFeed');
            if (!feed) return;
            
            // Clear existing content
            feed.innerHTML = '';
            
            // Create video feed items
            currentVideos.forEach((video, index) => {
                const videoItem = document.createElement('div');
                videoItem.className = 'vine-video-feed-item';
                videoItem.innerHTML = `
                    <div class="vine-video-header">
                        <div class="vine-user-avatar">${video.avatar}</div>
                        <div class="vine-user-info">
                            <div class="vine-username">${video.username}</div>
                            <div class="vine-timestamp">${getTimeAgo()}</div>
                        </div>
                    </div>
                    <div class="vine-video-container">
                        <video src="${video.url}" 
                               id="video-${video.id}"
                               loop 
                               ${isMuted ? 'muted' : ''}
                               playsinline
                               onclick="toggleVideoPlay('${video.id}')"
                               onmouseover="this.play()" 
                               onmouseout="this.pause()">
                        </video>
                    </div>
                    <div class="vine-video-footer">
                        <div class="vine-video-caption">${video.title}</div>
                        <!-- Engagement metrics hidden until real data available -->
                    </div>
                `;
                feed.appendChild(videoItem);
            });
        }
        
        // Toggle video play/pause and global mute
        function toggleVideoPlay(videoId) {
            const clickedVideo = document.getElementById(`video-${videoId}`);
            if (!clickedVideo) return;
            
            if (clickedVideo.paused) {
                // If unmuting for the first time, unmute all videos globally
                if (isMuted) {
                    isMuted = false;
                    // Unmute all videos
                    document.querySelectorAll('video').forEach(video => {
                        video.muted = false;
                    });
                }
                clickedVideo.play();
            } else {
                clickedVideo.pause();
            }
        }

        // Load playlist video
        function loadPlaylistVideo() {
            if (currentVideos.length === 0) return;
            
            const video = currentVideos[featuredVideoIndex];
            const player = document.getElementById('vinePlaylistPlayer');
            const title = document.getElementById('playlistVideoTitle');
            const currentIndex = document.getElementById('currentVideoIndex');
            const totalVideos = document.getElementById('totalVideos');
            const loopCount = document.getElementById('loopCount');

            if (player && video.url) {
                // Remove old source
                player.pause();
                player.src = video.url;
                console.log('Loading video:', video.url, 'for video:', video.title);
                // Check if VineState is available from vine-integration.js
                if (typeof window.VineState !== 'undefined') {
                    player.muted = window.VineState.playlistMuted;
                    player.volume = window.VineState.playlistMuted ? 0 : 1.0;
                } else {
                    player.muted = isMuted;
                    player.volume = isMuted ? 0 : 1.0;
                }
                
                // Add error handling for broken videos
                player.addEventListener('error', function handleVideoError() {
                    console.log('Video failed to load:', video.url);
                    // Skip to next video if this one fails
                    setTimeout(() => {
                        featuredVideoIndex = (featuredVideoIndex + 1) % currentVideos.length;
                        loadPlaylistVideo();
                    }, 1000);
                    player.removeEventListener('error', handleVideoError);
                });
                
                player.load();
                
                // Check if video has audio track
                player.addEventListener('loadedmetadata', function checkAudio() {
                    console.log('Video loaded - Duration:', player.duration, 'Has Audio:', player.mozHasAudio || player.webkitAudioDecodedByteCount > 0 || player.audioTracks?.length > 0);
                    player.removeEventListener('loadedmetadata', checkAudio);
                });
                
                player.play().catch(e => {
                    console.log('Autoplay prevented:', e);
                    player.muted = true;
                    isMuted = true;
                    player.play().catch(e2 => {
                        console.log('Even muted autoplay failed:', e2);
                        // If video won't play at all, skip to next
                        setTimeout(() => {
                            featuredVideoIndex = (featuredVideoIndex + 1) % currentVideos.length;
                            loadPlaylistVideo();
                        }, 2000);
                    });
                });
            }
            
            if (title) title.textContent = video.username;
            if (currentIndex) currentIndex.textContent = featuredVideoIndex + 1;
            if (totalVideos) totalVideos.textContent = currentVideos.length;
            // Loop count hidden until real data available
            if (loopCount) loopCount.textContent = '';
        }

        // Load video grid
        function loadVideoGrid() {
            const grid = document.getElementById('vineVideoGrid');
            if (!grid) return;
            
            grid.innerHTML = currentVideos.map((video, index) => `
                <div class="vine-grid-item" data-video-id="${video.id}" onclick="playVideo('${video.id}')">
                    <div class="vine-grid-thumbnail" id="thumb-${video.id}">
                        <canvas width="400" height="400" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;"></canvas>
                        <div class="vine-grid-overlay">
                            <div class="vine-grid-avatar">${video.avatar}</div>
                            <span class="vine-grid-user">${video.username}</span>
                        </div>
                    </div>
                    <div class="vine-grid-info">
                        <div class="vine-grid-avatar" style="width: 20px; height: 20px; font-size: 10px;">${video.avatar}</div>
                        <span style="font-size: 11px; color: #333;">${video.username}</span>
                        <!-- Engagement metrics hidden until real data available -->
                    </div>
                </div>
            `).join('');
            
            // Add placeholder for empty slots to maintain grid
            const remainingSlots = 9 - (currentVideos.length % 9);
            if (remainingSlots < 9) {
                for (let i = 0; i < remainingSlots; i++) {
                    grid.innerHTML += '<div class="vine-grid-placeholder"></div>';
                }
            }
            
            // Generate thumbnails after grid is loaded
            setTimeout(() => generateThumbnails(), 100);
        }

        // Load featured viners
        function loadFeaturedViners() {
            const vinersList = document.getElementById('featuredVinersList');
            if (!vinersList) return;
            
            const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#ff8cc8', '#95e1d3'];
            const featuredUsers = getFeaturedUsers();
            
            if (featuredUsers.length === 0) {
                vinersList.innerHTML = '<div style="text-align: center; color: #666;">Loading featured viners...</div>';
                return;
            }
            
            vinersList.innerHTML = featuredUsers.map((user, index) => `
                <div class="vine-viner-item" onclick="viewProfile('${user.username}')">
                    <div class="vine-viner-avatar" style="background: ${colors[index % colors.length]}">
                        ${user.avatar}
                    </div>
                    <div class="vine-viner-info">
                        <div class="vine-viner-name">${user.username}</div>
                        <div class="vine-viner-followers">${user.followers} loops</div>
                    </div>
                </div>
            `).join('');
        }

        // Load trending videos
        function loadTrendingVideos() {
            const trendingGrid = document.getElementById('vineTrendingGrid');
            if (!trendingGrid) return;
            
            const trendingVideos = currentVideos.slice(3, 9);
            
            trendingGrid.innerHTML = trendingVideos.map((video, index) => `
                <div class="vine-grid-item" onclick="playVideo('${video.id}')">
                    <div class="vine-grid-thumbnail" id="trending-thumb-${video.id}">
                        <canvas width="400" height="400" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;"></canvas>
                        <div class="vine-grid-overlay">
                            <div class="vine-grid-avatar">${video.avatar}</div>
                            <span class="vine-grid-user">${video.username}</span>
                        </div>
                    </div>
                    <div class="vine-grid-info">
                        <div class="vine-grid-avatar" style="width: 20px; height: 20px; font-size: 10px;">${video.avatar}</div>
                        <span style="font-size: 11px; color: #333;">${video.username}</span>
                        <!-- Engagement metrics hidden until real data available -->
                    </div>
                </div>
            `).join('');
            
            // Generate trending thumbnails
            setTimeout(() => {
                trendingVideos.forEach((video, index) => {
                    const canvas = document.querySelector(`#trending-thumb-${video.id} canvas`);
                    if (!canvas) return;
                    
                    const ctx = canvas.getContext('2d');
                    const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#ff8cc8', '#95e1d3'];
                    
                    // Generate thumbnails same as main grid
                    const tempVideo = document.createElement('video');
                    tempVideo.src = video.url;
                    tempVideo.muted = true;
                    tempVideo.crossOrigin = 'anonymous';
                    
                    tempVideo.addEventListener('loadeddata', () => {
                        tempVideo.currentTime = Math.min(1, tempVideo.duration * 0.1);
                    });
                    
                    tempVideo.addEventListener('seeked', () => {
                        try {
                            ctx.drawImage(tempVideo, 0, 0, 400, 400);
                        } catch (e) {
                            ctx.fillStyle = colors[index % colors.length];
                            ctx.fillRect(0, 0, 400, 400);
                            ctx.fillStyle = 'white';
                            ctx.font = '120px Arial';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(video.avatar, 200, 200);
                        }
                        tempVideo.remove();
                    });
                    
                    tempVideo.addEventListener('error', () => {
                        ctx.fillStyle = colors[index % colors.length];
                        ctx.fillRect(0, 0, 400, 400);
                        ctx.fillStyle = 'white';
                        ctx.font = '120px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(video.avatar, 200, 200);
                        tempVideo.remove();
                    });
                    
                    tempVideo.load();
                });
            }, 100);
        }

        // Setup video autoplay
        function setupVideoAutoplay() {
            setInterval(() => {
                featuredVideoIndex = (featuredVideoIndex + 1) % currentVideos.length;
                loadFeaturedVideo();
            }, 6000);
        }

        // Click to toggle play/pause
        document.addEventListener('DOMContentLoaded', () => {
            const player = document.getElementById('vineFeaturedPlayer');
            if (player) {
                player.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (player.paused) {
                        player.play();
                    } else {
                        player.pause();
                    }
                });
            }
        });

        // Play video
        function playVideo(videoId) {
            const videoIndex = currentVideos.findIndex(v => v.id === videoId);
            if (videoIndex !== -1) {
                featuredVideoIndex = videoIndex;
                loadPlaylistVideo();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Setup hover preview for grid items
        function setupHoverPreviews() {
            const gridItems = document.querySelectorAll('.vine-grid-item');
            
            gridItems.forEach((item, index) => {
                const thumbnail = item.querySelector('.vine-grid-thumbnail');
                if (!thumbnail || !currentVideos[index]) return;
                
                let previewVideo = null;
                let hoverTimeout = null;
                
                item.addEventListener('mouseenter', () => {
                    // Delay preview to avoid accidental hovers
                    hoverTimeout = setTimeout(() => {
                        const video = currentVideos[index];
                        if (!video.url) return;
                        
                        // Create preview video element
                        previewVideo = document.createElement('video');
                        previewVideo.src = video.url;
                        previewVideo.muted = true;
                        previewVideo.loop = true;
                        previewVideo.style.position = 'absolute';
                        previewVideo.style.top = '0';
                        previewVideo.style.left = '0';
                        previewVideo.style.width = '100%';
                        previewVideo.style.height = '100%';
                        previewVideo.style.objectFit = 'cover';
                        previewVideo.style.zIndex = '5';
                        
                        thumbnail.appendChild(previewVideo);
                        previewVideo.play().catch(e => console.log('Preview play failed:', e));
                    }, 300); // 300ms delay before preview starts
                });
                
                item.addEventListener('mouseleave', () => {
                    // Clear timeout if mouse leaves before preview starts
                    if (hoverTimeout) {
                        clearTimeout(hoverTimeout);
                        hoverTimeout = null;
                    }
                    
                    // Remove preview video
                    if (previewVideo) {
                        previewVideo.pause();
                        previewVideo.remove();
                        previewVideo = null;
                    }
                });
            });
        }

        // Note: No crypto libraries needed - vine.hol.is allows unauthenticated reads!

        // Inline search functionality
        let searchResults = {
            videos: [],
            profiles: [],
            playlists: []
        };

        // nostr-tools for Nostr operations
        let relay = null;
        let searchSubscription = null;

        // Initialize relay connection (try nostr-tools, fallback to WebSocket)
        async function initializeNostrRelay() {
            if (relay && relay.status === 1) return relay; // Already connected
            
            // For now, let's use the reliable WebSocket implementation
            console.log('üîÑ Using WebSocket implementation for vine.hol.is');
            return await initializeWebSocketRelay();
        }

        // Fallback WebSocket implementation
        async function initializeWebSocketRelay() {
            return new Promise((resolve, reject) => {
                try {
                    const ws = new WebSocket('wss://vine.hol.is');
                    let subscriptions = new Map();
                    
                    ws.onopen = () => {
                        console.log('‚úÖ WebSocket connected to vine.hol.is relay');
                        
                        const relayObject = {
                            status: 1,
                            sub: (filters) => {
                                const subId = 'sub_' + Math.random().toString(36).substring(2);
                                const subscription = {
                                    handlers: {},
                                    unsub: () => {
                                        ws.send(JSON.stringify(['CLOSE', subId]));
                                        subscriptions.delete(subId);
                                    },
                                    on: (eventType, handler) => {
                                        subscription.handlers[eventType] = handler;
                                    }
                                };
                                
                                // Store the subscription
                                subscriptions.set(subId, subscription);
                                
                                // Send REQ message
                                ws.send(JSON.stringify(['REQ', subId, ...filters]));
                                console.log(`üì§ Sent REQ for ${subId}:`, ['REQ', subId, ...filters]);
                                
                                return subscription;
                            }
                        };
                        
                        ws.onmessage = (event) => {
                            try {
                                const message = JSON.parse(event.data);
                                const [type, subId, ...args] = message;
                                
                                const subscription = subscriptions.get(subId);
                                if (!subscription || !subscription.handlers) return;
                                
                                if (type === 'EVENT' && subscription.handlers.event) {
                                    subscription.handlers.event(args[0]);
                                } else if (type === 'EOSE' && subscription.handlers.eose) {
                                    subscription.handlers.eose();
                                } else if (type === 'NOTICE') {
                                    console.log('üì¢ Relay notice:', args[0]);
                                } else if (type === 'OK') {
                                    console.log('‚úÖ Relay OK:', args);
                                }
                            } catch (e) {
                                console.error('Error parsing WebSocket message:', e);
                            }
                        };
                        
                        resolve(relayObject);
                    };
                    
                    ws.onerror = () => {
                        console.error('‚ùå WebSocket connection failed');
                        reject(new Error('WebSocket connection failed'));
                    };
                    
                    ws.onclose = () => {
                        console.log('üëã WebSocket disconnected');
                    };
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function searchVinesWithOverlay() {
            console.log('üöÄ searchVinesWithOverlay function called with nostr-tools!');
            const query = document.getElementById('vineSearchInput').value.trim();
            console.log('üìù Query:', query);
            
            if (!query) {
                console.log('‚ùå No query, hiding results');
                hideSearchResults();
                return;
            }

            console.log('‚úÖ Query found, showing search overlay...');
            
            // Show loading state with animation
            showSearchResults();
            showLoadingAnimation();
            addSearchInputAnimation();

            console.log('üîç Searching for:', query);

            // Reset results
            searchResults = { videos: [], profiles: [], playlists: [] };

            try {
                // Initialize relay if needed
                const relayInstance = await initializeNostrRelay();
                if (!relayInstance) {
                    throw new Error('Failed to initialize nostr-tools relay');
                }

                updateLoadingText('Connected! Searching for content');

                // Close any existing subscription
                if (searchSubscription) {
                    searchSubscription.unsub();
                }

                // Create filter for search - search all users, not just the main feed user
                const filter = {
                    kinds: [0, 22, 30023], // Profiles, Videos, Playlists
                    limit: 500,
                    since: Math.floor(Date.now() / 1000) - (365 * 24 * 60 * 60) // Last year to catch older profiles
                    // Note: NO authors filter here - we want to search all content
                };

                console.log('üì§ Creating nostr-tools subscription with filter:', filter);

                let eventCount = 0;

                // Create subscription using nostr-tools
                searchSubscription = relayInstance.sub([filter]);

                // Handle events
                searchSubscription.on('event', (event) => {
                    eventCount++;
                    console.log(`üì¶ Received Kind ${event.kind} event #${eventCount} from ${event.pubkey.slice(0, 8)}...`);
                    
                    const searchResult = processNostrToolsSearchEvent(event, query);

                    if (searchResult) {
                        console.log(`üéØ Match found: ${searchResult.type}`);
                        
                        // Check for duplicates before adding
                        if (searchResult.type === 'video') {
                            const exists = searchResults.videos.find(v => v.url === searchResult.url);
                            if (!exists) {
                                searchResults.videos.push(searchResult);
                            } else {
                                console.log(`üîÑ Skipped duplicate video URL: ${searchResult.url}`);
                            }
                        } else if (searchResult.type === 'profile') {
                            const exists = searchResults.profiles.find(p => p.pubkey === searchResult.pubkey);
                            if (!exists) {
                                searchResults.profiles.push(searchResult);
                            } else {
                                console.log(`üîÑ Skipped duplicate profile: ${searchResult.pubkey.slice(0, 8)}...`);
                            }
                        } else if (searchResult.type === 'playlist') {
                            const exists = searchResults.playlists.find(p => p.id === searchResult.id);
                            if (!exists) {
                                searchResults.playlists.push(searchResult);
                            } else {
                                console.log(`üîÑ Skipped duplicate playlist: ${searchResult.id}`);
                            }
                        }
                    }
                });

                // Handle end of events
                searchSubscription.on('eose', () => {
                    console.log(`üìã End of stored events - processed ${eventCount} total events`);
                    hideLoadingAnimation();
                    removeSearchInputAnimation();
                    processInlineSearchResults(query);
                });

                // Set timeout as fallback
                setTimeout(() => {
                    if (searchSubscription) {
                        console.log('‚è∞ Search timeout reached');
                        searchSubscription.unsub();
                        hideLoadingAnimation();
                        removeSearchInputAnimation();
                        processInlineSearchResults(query);
                    }
                }, 10000);

            } catch (error) {
                console.error('‚ùå nostr-tools search error:', error);
                hideLoadingAnimation();
                removeSearchInputAnimation();
                updateSearchStatus('Connection failed, showing local results...');
                fallbackToLocalSearch(query);
            }
        }

        // nostr-tools-based search result processing functions
        function processNostrToolsSearchEvent(event, searchQuery) {
            const searchLower = searchQuery.toLowerCase();

            switch (event.kind) {
                case 0: // User Profile
                    return searchNostrToolsProfile(event, searchLower);
                case 22: // Short Video  
                    return searchNostrToolsVideo(event, searchLower);
                case 30023: // Playlist
                    return searchNostrToolsPlaylist(event, searchLower);
                default:
                    return null;
            }
        }

        function searchNostrToolsProfile(event, searchLower) {
            try {
                const profile = JSON.parse(event.content);
                const matchesSearch = 
                    (profile.name && profile.name.toLowerCase().includes(searchLower)) ||
                    (profile.display_name && profile.display_name.toLowerCase().includes(searchLower)) ||
                    (profile.about && profile.about.toLowerCase().includes(searchLower)) ||
                    event.pubkey.toLowerCase().includes(searchLower);
                    
                if (matchesSearch) {
                    return {
                        type: 'profile',
                        pubkey: event.pubkey,
                        name: profile.name || profile.display_name || 'Unknown',
                        about: profile.about || '',
                        picture: profile.picture || '',
                        created_at: event.created_at
                    };
                }
            } catch (e) {
                console.error('Error parsing nostr-tools profile:', e);
            }
            return null;
        }

        function searchNostrToolsVideo(event, searchLower) {
            const matchesSearch = 
                (event.content && event.content.toLowerCase().includes(searchLower)) ||
                event.pubkey.toLowerCase().includes(searchLower) ||
                (event.tags && event.tags.some(tag => 
                    tag[0] === 't' && tag[1] && tag[1].toLowerCase().includes(searchLower)
                ));
                
            if (matchesSearch) {
                return convertNostrToolsEventToVideo(event);
            }
            return null;
        }

        function searchNostrToolsPlaylist(event, searchLower) {
            try {
                const playlist = JSON.parse(event.content);
                const matchesSearch = 
                    (playlist.name && playlist.name.toLowerCase().includes(searchLower)) ||
                    (playlist.description && playlist.description.toLowerCase().includes(searchLower)) ||
                    event.pubkey.toLowerCase().includes(searchLower);
                    
                if (matchesSearch) {
                    return {
                        type: 'playlist',
                        id: event.id,
                        pubkey: event.pubkey,
                        name: playlist.name || 'Untitled Playlist',
                        description: playlist.description || '',
                        created_at: event.created_at
                    };
                }
            } catch (e) {
                console.error('Error parsing nostr-tools playlist:', e);
            }
            return null;
        }

        function convertNostrToolsEventToVideo(event) {
            try {
                let videoUrl = '';
                let thumbnailUrl = '';
                let title = event.content || 'Classic Vine';

                // Extract video URLs from 'r' tags
                for (const tag of event.tags || []) {
                    if (tag[0] === 'r' && tag[1]) {
                        if (tag[2] === 'video') {
                            videoUrl = tag[1];
                        } else if (tag[2] === 'thumbnail') {
                            thumbnailUrl = tag[1];
                        } else if (!videoUrl && !tag[2]) {
                            videoUrl = tag[1];
                        }
                    }
                }

                if (!videoUrl) return null;

                // Clean up title
                if (title.length > 100) {
                    title = title.substring(0, 100) + '...';
                }

                return {
                    type: 'video',
                    id: event.id,
                    url: videoUrl,
                    username: `${event.pubkey.slice(0, 8)}...`,
                    title: title,
                    thumbnail: thumbnailUrl || videoUrl.replace('/media/', '/media/thumb_'),
                    pubkey: event.pubkey,
                    created_at: event.created_at
                };
            } catch (error) {
                console.error('Error converting nostr-tools video event:', error);
                return null;
            }
        }

        // UI functions for search results
        function showSearchResults() {
            const container = document.getElementById('searchResultsContainer');
            console.log('üîç Showing search results container:', container);
            if (container) {
                container.style.display = 'block';
                console.log('‚úÖ Search overlay now visible');
            } else {
                console.error('‚ùå Could not find search results container');
            }
        }

        function hideSearchResults() {
            // Stop any currently playing video when closing search
            stopCurrentlyPlayingVideo();
            
            // Stop any active nostr-tools subscription
            if (searchSubscription) {
                console.log('üõë Stopping nostr-tools subscription');
                searchSubscription.unsub();
                searchSubscription = null;
            }
            
            document.getElementById('searchResultsContainer').style.display = 'none';
            document.getElementById('vineSearchInput').value = '';
            removeSearchInputAnimation();
        }

        function updateSearchStatus(message) {
            document.getElementById('searchStatus').textContent = message;
        }

        // Loading animation functions
        function showLoadingAnimation() {
            const searchContent = document.getElementById('searchResultsContent');
            searchContent.innerHTML = `
                <div class="search-loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">
                        <span class="loading-dots">Connecting to vine.hol.is relay</span>
                    </div>
                </div>
            `;
        }

        function hideLoadingAnimation() {
            // The animation will be replaced by actual results in processInlineSearchResults
        }

        function updateLoadingText(text) {
            const loadingText = document.querySelector('.loading-text .loading-dots');
            if (loadingText) {
                loadingText.textContent = text;
            }
        }

        function addSearchInputAnimation() {
            const searchInput = document.getElementById('vineSearchInput');
            console.log('üéØ Adding search animation to:', searchInput);
            if (searchInput) {
                searchInput.classList.add('searching');
                console.log('‚úÖ Added searching class');
            }
        }

        function removeSearchInputAnimation() {
            const searchInput = document.getElementById('vineSearchInput');
            console.log('üõë Removing search animation from:', searchInput);
            if (searchInput) {
                searchInput.classList.remove('searching');
                console.log('‚úÖ Removed searching class');
            }
        }

        function processInlineSearchResults(query) {
            const totalResults = searchResults.videos.length + searchResults.profiles.length + searchResults.playlists.length;

            if (totalResults > 0) {
                console.log(`‚úÖ Found ${totalResults} results`);
                
                // Update status
                const resultParts = [];
                if (searchResults.videos.length > 0) resultParts.push(`${searchResults.videos.length} videos`);
                if (searchResults.profiles.length > 0) resultParts.push(`${searchResults.profiles.length} profiles`);
                if (searchResults.playlists.length > 0) resultParts.push(`${searchResults.playlists.length} playlists`);
                
                updateSearchStatus(`Found ${resultParts.join(', ')} for "${query}"`);
                document.getElementById('searchResultsTitle').textContent = `Search Results for "${query}"`;

                // Display results
                document.getElementById('searchResultsContent').innerHTML = displayInlineSearchResults();
            } else {
                console.log('‚ùå No results found');
                updateSearchStatus('No results found');
                document.getElementById('searchResultsContent').innerHTML = `
                    <div class="search-section">
                        <div style="text-align: center; color: #666; font-size: 18px; padding: 40px;">
                            No results found for "${query}"<br>
                            <small>Try searching for "vine", "classic", or other keywords</small>
                        </div>
                    </div>
                `;
            }
        }

        function displayInlineSearchResults() {
            let html = '';

            // Display videos
            if (searchResults.videos.length > 0) {
                html += `
                    <div class="search-section">
                        <h3>Videos (${searchResults.videos.length})</h3>
                        <div class="search-results-grid">
                            ${searchResults.videos.map(video => `
                                <div class="search-video-card" onclick="playInlineVideo('${video.id}')">
                                    <div class="search-video-thumbnail">
                                        <video preload="metadata" muted onloadedmetadata="this.currentTime = 1">
                                            <source src="${video.url}" type="video/mp4">
                                        </video>
                                    </div>
                                    <div class="search-video-info">
                                        <div class="search-video-title">${video.title}</div>
                                        <div class="search-video-author">by ${video.username}</div>
                                        <div class="search-video-stats">
                                            <span>üìÖ ${new Date(video.created_at * 1000).toLocaleDateString()}</span>
                                            <span>üîÑ Vine</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Display profiles (if any)
            if (searchResults.profiles.length > 0) {
                html += `
                    <div class="search-section">
                        <h3>Profiles (${searchResults.profiles.length})</h3>
                        <div style="display: grid; gap: 15px;">
                            ${searchResults.profiles.map(profile => `
                                <div style="background: white; padding: 15px; border-radius: 10px; border: 1px solid #eee;">
                                    <div style="font-weight: bold; margin-bottom: 5px;">${profile.name}</div>
                                    <div style="color: #666; font-size: 14px;">${profile.about}</div>
                                    <div style="color: #999; font-size: 12px; margin-top: 8px;">
                                        ${profile.pubkey.slice(0, 16)}...
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Display playlists (if any)
            if (searchResults.playlists.length > 0) {
                html += `
                    <div class="search-section">
                        <h3>Playlists (${searchResults.playlists.length})</h3>
                        <div style="display: grid; gap: 15px;">
                            ${searchResults.playlists.map(playlist => `
                                <div style="background: white; padding: 15px; border-radius: 10px; border: 1px solid #eee;">
                                    <div style="font-weight: bold; margin-bottom: 5px;">${playlist.name}</div>
                                    <div style="color: #666; font-size: 14px;">${playlist.description}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            return html;
        }

        // Global variable to track currently playing video
        let currentPlayingVideoId = null;

        function stopCurrentlyPlayingVideo() {
            if (!currentPlayingVideoId) return;
            
            console.log('Stopping currently playing video:', currentPlayingVideoId);
            
            // Find the currently playing video card
            const currentVideoCard = document.querySelector(`[onclick="pauseInlineVideo('${currentPlayingVideoId}')"]`);
            if (currentVideoCard) {
                // Find and stop the video element
                const videoElement = currentVideoCard.querySelector('video.playing');
                if (videoElement) {
                    videoElement.pause();
                    videoElement.src = ''; // Clear source to stop loading
                }
                
                // Restore thumbnail
                const video = searchResults.videos.find(v => v.id === currentPlayingVideoId);
                if (video) {
                    const thumbnailDiv = currentVideoCard.querySelector('.search-video-thumbnail');
                    if (thumbnailDiv) {
                        thumbnailDiv.innerHTML = `
                            <video preload="metadata" muted onloadedmetadata="this.currentTime = 1">
                                <source src="${video.url}" type="video/mp4">
                            </video>
                        `;
                    }
                }
                
                // Restore original click behavior
                currentVideoCard.setAttribute('onclick', `playInlineVideo('${currentPlayingVideoId}')`);
            }
            
            // Clear the currently playing video ID
            currentPlayingVideoId = null;
        }

        function playInlineVideo(videoId) {
            console.log('Playing video:', videoId);
            
            // Stop any currently playing video first
            if (currentPlayingVideoId && currentPlayingVideoId !== videoId) {
                stopCurrentlyPlayingVideo();
            }
            
            // Find the video in our search results
            const video = searchResults.videos.find(v => v.id === videoId);
            if (!video) {
                console.error('Video not found');
                return;
            }
            
            // Find the video card that was clicked
            const videoCard = document.querySelector(`[onclick="playInlineVideo('${videoId}')"]`);
            if (!videoCard) {
                console.error('Video card not found');
                return;
            }
            
            // Find the thumbnail container
            const thumbnailDiv = videoCard.querySelector('.search-video-thumbnail');
            if (!thumbnailDiv) {
                console.error('Thumbnail container not found');
                return;
            }
            
            // Check if already playing
            if (thumbnailDiv.querySelector('video.playing')) {
                console.log('Video already playing');
                return;
            }
            
            // Create new video element
            const videoElement = document.createElement('video');
            videoElement.className = 'playing';
            videoElement.style.cssText = `
                width: 100%;
                height: 100%;
                object-fit: cover;
                background: #000;
            `;
            videoElement.controls = true;
            videoElement.autoplay = true;
            videoElement.loop = true; // Classic Vine behavior
            videoElement.muted = false; // Allow sound
            videoElement.preload = 'metadata';
            
            // Set video source and handle loading
            videoElement.src = video.url;
            
            videoElement.addEventListener('loadeddata', () => {
                console.log('‚úÖ Video loaded successfully');
            });
            
            videoElement.addEventListener('error', (e) => {
                console.error('‚ùå Video load error:', e);
                console.log('üîó Attempted URL:', video.url);
                // Fallback: restore original thumbnail
                thumbnailDiv.innerHTML = `
                    <video preload="metadata" muted onloadedmetadata="this.currentTime = 1">
                        <source src="${video.url}" type="video/mp4">
                    </video>
                `;
            });
            
            // Replace thumbnail content with playing video
            thumbnailDiv.innerHTML = '';
            thumbnailDiv.appendChild(videoElement);
            
            // Set this video as currently playing
            currentPlayingVideoId = videoId;
            
            // Change card click behavior to pause/play
            videoCard.setAttribute('onclick', `pauseInlineVideo('${videoId}')`);
        }
        
        function pauseInlineVideo(videoId) {
            console.log('Pausing video:', videoId);
            
            // Find the video card
            const videoCard = document.querySelector(`[onclick="pauseInlineVideo('${videoId}')"]`);
            if (!videoCard) return;
            
            // Find the video element
            const videoElement = videoCard.querySelector('video.playing');
            if (!videoElement) return;
            
            // Pause the video
            videoElement.pause();
            
            // Restore thumbnail
            const video = searchResults.videos.find(v => v.id === videoId);
            if (video) {
                const thumbnailDiv = videoCard.querySelector('.search-video-thumbnail');
                if (thumbnailDiv) {
                    thumbnailDiv.innerHTML = `
                        <video preload="metadata" muted onloadedmetadata="this.currentTime = 1">
                            <source src="${video.url}" type="video/mp4">
                        </video>
                    `;
                }
            }
            
            // Clear currently playing video
            if (currentPlayingVideoId === videoId) {
                currentPlayingVideoId = null;
            }
            
            // Restore original click behavior
            videoCard.setAttribute('onclick', `playInlineVideo('${videoId}')`);
        }

        function fallbackToLocalSearch(query) {
            // Fallback search implementation
            console.log('Falling back to local search for:', query);
            updateSearchStatus('Using local search results');
            
            // Search local videos if available
            if (allNostrVideos && allNostrVideos.length > 0) {
                const localResults = allNostrVideos.filter(v => 
                    v.username.toLowerCase().includes(query.toLowerCase()) ||
                    v.category.toLowerCase().includes(query.toLowerCase()) ||
                    v.title.toLowerCase().includes(query.toLowerCase())
                );
                
                if (localResults.length > 0) {
                    searchResults.videos = localResults.map(v => ({
                        type: 'video',
                        id: v.id,
                        url: v.url,
                        username: v.username,
                        title: v.title,
                        thumbnail: v.thumbnail,
                        created_at: v.created_at || Math.floor(Date.now() / 1000)
                    }));
                    
                    processInlineSearchResults(query);
                    return;
                }
            }
            
            // No local results either
            processInlineSearchResults(query);
        }

        // Filter by category
        function filterByCategory(category) {
            console.log('Filtering by:', category);
            console.log('Available videos:', allNostrVideos.length);
            console.log('Categories in videos:', [...new Set(allNostrVideos.map(v => v.category))]);
            
            const filtered = allNostrVideos.filter(v => {
                // Check if video category matches
                if (v.category === category) return true;
                
                // Also check hashtags for category match
                if (v.hashtags && v.hashtags.includes(category)) return true;
                
                // Map channel names to potential hashtags
                const categoryMap = {
                    'comedy': ['comedy', 'funny', 'humor', 'lol'],
                    'gaming': ['gaming', 'game', 'games', 'gamer'],
                    'cool': ['cool', 'awesome', 'amazing'],
                    'girls': ['girls', 'girl', 'women'],
                    'guys': ['guys', 'men', 'dudes'],
                    'musicdance': ['music', 'dance', 'song', 'singing'],
                    'popnow': ['trending', 'popular', 'viral'],
                    'ideas': ['idea', 'diy', 'howto', 'tutorial'],
                    'trending': ['trending', 'hot', 'viral'],
                    'special': ['special', 'unique', 'featured'],
                    'animals': ['animals', 'pets', 'animal', 'dog', 'cat'],
                    'places': ['travel', 'place', 'location', 'vacation'],
                    'family': ['family', 'kids', 'parenting'],
                    'artdesign': ['art', 'design', 'creative', 'drawing'],
                    'scary': ['scary', 'horror', 'creepy', 'spooky'],
                    'sports': ['sports', 'sport', 'fitness', 'workout'],
                    'cars': ['cars', 'car', 'auto', 'vehicle'],
                    'food': ['food', 'cooking', 'recipe', 'eat'],
                    'diy': ['diy', 'howto', 'make', 'craft'],
                    'news': ['news', 'politics', 'current'],
                    'fashion': ['fashion', 'style', 'outfit', 'beauty'],
                    'nature': ['nature', 'outdoor', 'landscape']
                };
                
                // Check if any hashtags match the category mappings
                if (categoryMap[category] && v.hashtags) {
                    return v.hashtags.some(tag => 
                        categoryMap[category].includes(tag.toLowerCase())
                    );
                }
                
                return false;
            });
            
            console.log(`Found ${filtered.length} videos for category: ${category}`);
            
            if (filtered.length > 0) {
                currentVideos = filtered;
                featuredVideoIndex = 0; // Reset to first video
                loadVideoFeed(); // Update the feed display
                // Also update grid if it exists
                if (document.getElementById('vineVideoGrid')) {
                    loadVideoGrid();
                }
                
                // Update UI to show active category
                const clickedItem = event.target;
                const wasActive = clickedItem.classList.contains('active');
                
                document.querySelectorAll('.vine-category-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // If clicking an already active category, show all videos
                if (wasActive) {
                    currentVideos = shuffleArray([...allNostrVideos]);
                    featuredVideoIndex = 0;
                    loadVideoFeed();
                    console.log('Showing all videos');
                } else {
                    clickedItem.classList.add('active');
                }
            } else {
                // Show all videos if no matches
                currentVideos = shuffleArray([...allNostrVideos]);
                featuredVideoIndex = 0;
                loadVideoFeed();
                console.log(`No ${category} vines found, showing all`);
                
                // Show notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 20px 30px;
                    border-radius: 10px;
                    font-size: 16px;
                    z-index: 1000;
                `;
                notification.textContent = `No vines found in "${category}" category`;
                document.body.appendChild(notification);
                
                setTimeout(() => notification.remove(), 2000);
            }
        }

        // View profile
        function viewProfile(username) {
            console.log('Viewing profile:', username);
            window.location.href = `/${encodeURIComponent(username)}`;
        }

        // Show playlist
        function showPlaylist(playlistType) {
            console.log('Showing playlist:', playlistType);
            
            if (playlistType === 'editors-picks') {
                // Show curated editor's picks
                currentVideos = allNostrVideos.filter((v, i) => i % 2 === 0); // Even indexed videos
                loadVideoGrid();
                loadFeaturedVideo();
                alert("Editor's Picks - Curated selection of the best vines!");
            } else if (playlistType === 'featured') {
                // Show featured viners' videos
                currentVideos = allNostrVideos.filter((v, i) => i % 2 === 1); // Odd indexed videos
                loadVideoGrid();
                loadFeaturedVideo();
                alert("Featured Viners - Trending creators and their best content!");
            }
            
            setTimeout(setupHoverPreviews, 100);
        }

        // Handle enter key in search
        document.addEventListener('DOMContentLoaded', async () => {
            const searchInput = document.getElementById('vineSearchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchVinesWithOverlay();
                    }
                });
            }
            
            // Pre-initialize nostr-tools relay for faster searches
            console.log('üöÄ Initializing nostr-tools relay on page load...');
            try {
                await initializeNostrRelay();
                console.log('‚úÖ nostr-tools relay pre-initialized successfully');
            } catch (error) {
                console.log('‚ö†Ô∏è nostr-tools relay pre-initialization failed, will retry during search:', error);
            }
        });

        // Try to load from vine-integration.js if available
        function loadFromVineIntegration() {
            // This will integrate with the vine-integration.js file if it loads
            if (typeof window.VineState !== 'undefined' && window.VineState.videos && window.VineState.videos.length > 0) {
                // Only replace if we actually have videos
                console.log('Vine integration found with', window.VineState.videos.length, 'videos');
                currentVideos = window.VineState.videos;
                loadPlaylistVideo();
                // Don't reload featured content - keep our custom comedy videos
                // loadFeaturedCategoryVideos();
                // loadVideoGrid();
                // setTimeout(setupHoverPreviews, 100);
            } else {
                console.log('No vine integration data found, keeping preloaded content');
            }
        }

        // Load featured category videos
        function loadFeaturedCategoryVideos(category = 'comedy') {
            const grid = document.getElementById('featuredCategoryGrid');
            const titleElement = document.querySelector('.vine-featured-section .vine-section-title');
            if (!grid) return;
            
            // Update the section title
            const categoryNames = {
                'comedy': 'Comedy',
                'gaming': 'Gaming', 
                'cool': 'Cool',
                'trending': 'Trending',
                'special': 'Special',
                'animals': 'Animals',
                'sports': 'Sports',
                'musicdance': 'Music & Dance',
                'ideas': 'Ideas',
                'editors-picks': 'Editor\'s Picks'
            };
            
            if (titleElement) {
                titleElement.innerHTML = `
                    <div class="vine-category-icon">üìπ</div>
                    Featured in ${categoryNames[category] || category}
                `;
            }
            
            // Get videos from the specified category
            const categoryVideos = allNostrVideos.filter(v => v.category === category).slice(0, 3).map(video => ({
                id: video.id,
                url: video.url,
                username: video.username,
                avatar: video.avatar,
                caption: video.title,
                loops: video.loops
            }));
            
            grid.innerHTML = categoryVideos.map(video => `
                <div class="vine-featured-item" onclick="playFromPlaylist('${video.id}')">
                    <div class="vine-featured-thumb">
                        <video src="${video.url}" muted preload="metadata" onloadedmetadata="this.currentTime = 1" 
                               onclick="event.stopPropagation(); this.muted = false; this.volume = 1.0;"></video>
                    </div>
                    <div class="vine-featured-info">
                        <div class="vine-featured-user">
                            <span class="vine-user-avatar-small">${video.avatar}</span>
                            <span class="vine-username-small">${video.username}</span>
                        </div>
                        <p class="vine-featured-caption">${video.caption}</p>
                        <!-- Loop count hidden until real data available -->
                    </div>
                </div>
            `).join('');
        }
        
        // Load featured viners row
        function loadFeaturedVinersRow() {
            const row = document.getElementById('featuredVinersRow');
            if (!row) return;
            
            // Get unique users from our video data
            const uniqueUsers = [...new Set(currentVideos.map(v => v.username))].slice(0, 4);
            const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#333'];
            const viners = uniqueUsers.map((username, index) => {
                const userVideo = currentVideos.find(v => v.username === username);
                return {
                    name: username,
                    avatar: userVideo ? userVideo.avatar : 'üë§',
                    color: colors[index]
                };
            });
            
            row.innerHTML = viners.map(viner => `
                <div class="vine-viner-circle" onclick="viewProfile('${viner.name}')">
                    <div class="vine-viner-avatar" style="background: ${viner.color}">
                        ${viner.avatar}
                    </div>
                    <p class="vine-viner-name">${viner.name}</p>
                </div>
            `).join('');
        }
        
        // Load editor's pick video
        function loadEditorsPickVideo() {
            const container = document.getElementById('editorsPickVideo');
            if (!container) return;
            
            // Pick a random video as editor's pick
            const editorsPick = currentVideos[Math.floor(Math.random() * currentVideos.length)];
            
            container.innerHTML = `
                <video src="${editorsPick.url}" 
                       id="editors-pick-video"
                       ${isMuted ? 'muted' : ''}
                       loop
                       playsinline
                       onclick="toggleEditorsPickVideo()"
                       onmouseover="this.play()" 
                       onmouseout="this.pause()">
                </video>
            `;
        }
        
        // Toggle editor's pick video
        function toggleEditorsPickVideo() {
            const video = document.getElementById('editors-pick-video');
            if (!video) return;
            
            if (video.paused) {
                // If unmuting for the first time, unmute all videos globally
                if (isMuted) {
                    isMuted = false;
                    // Unmute all videos
                    document.querySelectorAll('video').forEach(v => {
                        v.muted = false;
                    });
                }
                video.play();
            } else {
                video.pause();
            }
        }
        
        // Setup playlist navigation
        function setupPlaylistNavigation() {
            const player = document.getElementById('vinePlaylistPlayer');
            if (!player) return;
            
            // Click to toggle mute/unmute
            player.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                if (player.muted || player.volume === 0) {
                    // Unmute
                    player.muted = false;
                    player.volume = 1.0;
                    isMuted = false;
                    // Sync with VineState if available
                    if (typeof window.VineState !== 'undefined') {
                        window.VineState.playlistMuted = false;
                    }
                    
                    // Show unmute indicator
                    const indicator = document.createElement('div');
                    indicator.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.8);
                        color: white;
                        padding: 10px 20px;
                        border-radius: 20px;
                        font-size: 14px;
                        z-index: 1000;
                        pointer-events: none;
                    `;
                    indicator.textContent = 'üîä Sound On';
                    document.body.appendChild(indicator);
                    
                    setTimeout(() => {
                        indicator.remove();
                    }, 1000);
                    
                    console.log('Audio unmuted - volume:', player.volume, 'muted:', player.muted);
                } else {
                    // Mute
                    player.muted = true;
                    isMuted = true;
                    // Sync with VineState if available
                    if (typeof window.VineState !== 'undefined') {
                        window.VineState.playlistMuted = true;
                    }
                    console.log('Audio muted');
                }
            });
            
            // Also add handler to the wrapper
            const wrapper = player.closest('.vine-video-wrapper');
            if (wrapper) {
                wrapper.addEventListener('click', (e) => {
                    if (e.target !== player) {
                        player.click();
                    }
                });
            }
        }
        
        // Advance playlist
        function advancePlaylist() {
            featuredVideoIndex = (featuredVideoIndex + 1) % currentVideos.length;
            loadPlaylistVideo();
        }
        
        // Play from playlist
        function playFromPlaylist(videoId) {
            console.log('Playing video:', videoId);
            console.log('Current videos length:', currentVideos.length);
            const index = currentVideos.findIndex(v => v.id === videoId);
            console.log('Found index:', index);
            if (index !== -1) {
                featuredVideoIndex = index;
                loadPlaylistVideo();
                // Scroll to playlist
                document.querySelector('.vine-playlist-container').scrollIntoView({ behavior: 'smooth' });
            } else {
                // Video not in current list, find it in all videos and play directly
                const video = allNostrVideos.find(v => v.id === videoId);
                if (video) {
                    console.log('Video found in all videos, playing directly');
                    const player = document.getElementById('vinePlaylistPlayer');
                    if (player) {
                        player.src = video.url;
                        player.load();
                        player.play();
                    }
                }
            }
        }
        
        // Helper functions
        
        function shareVideo() {
            const currentVideo = currentVideos[featuredVideoIndex];
            if (!currentVideo) return;
            
            const shareUrl = `${window.location.origin}/#${currentVideo.id}`;
            
            if (navigator.share) {
                navigator.share({
                    title: `${currentVideo.title} by ${currentVideo.username}`,
                    text: 'Check out this classic vine!',
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    // Show temporary notification
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.8);
                        color: white;
                        padding: 10px 20px;
                        border-radius: 20px;
                        font-size: 14px;
                        z-index: 1000;
                    `;
                    notification.textContent = 'üîó Link copied to clipboard!';
                    document.body.appendChild(notification);
                    
                    setTimeout(() => notification.remove(), 2000);
                });
            }
        }
        
        function likeVideo() {
            const currentVideo = currentVideos[featuredVideoIndex];
            if (!currentVideo) return;
            
            // Simulate like (in real app would publish Nostr reaction event)
            currentVideo.likes = (currentVideo.likes || 0) + 1;
            
            // Update UI
            const likesElement = document.getElementById('featuredLikes');
            if (likesElement) {
                likesElement.textContent = currentVideo.likes.toLocaleString();
            }
            
            // Show heart animation
            const heart = document.createElement('div');
            heart.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 40px;
                color: #ff6b6b;
                z-index: 1000;
                pointer-events: none;
                animation: heartPulse 1s ease-out;
            `;
            heart.textContent = '‚ù§Ô∏è';
            document.body.appendChild(heart);
            
            // Add CSS for heart animation
            if (!document.getElementById('heartAnimation')) {
                const style = document.createElement('style');
                style.id = 'heartAnimation';
                style.textContent = `
                    @keyframes heartPulse {
                        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
                        50% { transform: translate(-50%, -50%) scale(1.2); }
                        100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            setTimeout(() => heart.remove(), 1000);
        }
        
        // Navigation functions
        function previousVideo() {
            if (currentVideos.length === 0) return;
            featuredVideoIndex = (featuredVideoIndex - 1 + currentVideos.length) % currentVideos.length;
            loadPlaylistVideo();
        }
        
        function nextVideo() {
            if (currentVideos.length === 0) return;
            featuredVideoIndex = (featuredVideoIndex + 1) % currentVideos.length;
            loadPlaylistVideo();
        }
        
        // Category filtering function  
        function filterByCategory(category) {
            console.log('Filtering by:', category);
            const filtered = allNostrVideos.filter(v => v.category === category);
            
            if (filtered.length > 0) {
                currentVideos = filtered;
                loadVideoFeed(); // Reload the feed with filtered videos
                
                console.log(`Filtered to ${filtered.length} videos in category: ${category}`);
            } else {
                // Reset to all videos if no matches
                currentVideos = [...allNostrVideos];
                loadVideoFeed();
                console.log(`No videos found for category: ${category}, showing all videos`);
            }
        }

        // Generate video thumbnails dynamically
        function generateThumbnails() {
            currentVideos.forEach((video, index) => {
                const thumbnailContainer = document.getElementById(`thumb-${video.id}`);
                if (!thumbnailContainer) return;
                
                const canvas = thumbnailContainer.querySelector('canvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#ff8cc8', '#95e1d3'];
                
                // Create a temporary video element to extract frame
                const tempVideo = document.createElement('video');
                tempVideo.src = video.url;
                tempVideo.muted = true;
                tempVideo.crossOrigin = 'anonymous';
                
                tempVideo.addEventListener('loadeddata', () => {
                    // Seek to 1 second or 10% of video duration
                    tempVideo.currentTime = Math.min(1, tempVideo.duration * 0.1);
                });
                
                tempVideo.addEventListener('seeked', () => {
                    try {
                        // Draw the video frame to canvas
                        ctx.drawImage(tempVideo, 0, 0, 400, 400);
                    } catch (e) {
                        // If video can't be drawn (CORS, etc), create colorful placeholder
                        ctx.fillStyle = colors[index % colors.length];
                        ctx.fillRect(0, 0, 400, 400);
                        ctx.fillStyle = 'white';
                        ctx.font = '120px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(video.avatar, 200, 200);
                    }
                    
                    // Clean up
                    tempVideo.remove();
                });
                
                tempVideo.addEventListener('error', () => {
                    // Create colorful placeholder on error
                    ctx.fillStyle = colors[index % colors.length];
                    ctx.fillRect(0, 0, 400, 400);
                    ctx.fillStyle = 'white';
                    ctx.font = '120px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(video.avatar, 200, 200);
                    
                    tempVideo.remove();
                });
                
                // Start loading
                tempVideo.load();
            });
        }

        // New Analytics API Functions
        
        // Get trending hashtags
        async function getTrendingHashtags() {
            try {
                const response = await fetch(`${ANALYTICS_API}/hashtags/trending`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                console.log('üìà Trending hashtags:', data);
                return data.hashtags || [];
            } catch (error) {
                console.error('‚ùå Error fetching trending hashtags:', error);
                return [];
            }
        }

        // Get trending videos for a specific hashtag
        async function getTrendingByHashtag(hashtag, timeframe = '24h') {
            try {
                const url = `${ANALYTICS_API}/hashtag/${hashtag}/trending?timeframe=${timeframe}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                console.log(`üìà Trending videos for #${hashtag}:`, data);
                return data.videos || [];
            } catch (error) {
                console.error(`‚ùå Error fetching trending videos for #${hashtag}:`, error);
                return [];
            }
        }

        // Get rapidly ascending videos (velocity)
        async function getVelocityVideos() {
            try {
                const response = await fetch(`${ANALYTICS_API}/trending/velocity`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                console.log('üöÄ Velocity videos:', data);
                return data.videos || [];
            } catch (error) {
                console.error('‚ùå Error fetching velocity videos:', error);
                return [];
            }
        }

        // Enhanced category filtering with analytics data
        async function filterByCategoryWithAnalytics(category) {
            console.log(`üéØ Filtering by category: ${category} with analytics data`);
            
            // Show loading state
            showLoadingAnimation();
            
            try {
                // Get trending videos for this hashtag
                const trendingVideos = await getTrendingByHashtag(category);
                
                if (trendingVideos.length > 0) {
                    // Fetch Nostr events for trending videos
                    const eventIds = trendingVideos.map(v => v.eventId).filter(Boolean);
                    if (eventIds.length > 0) {
                        await fetchNostrEventsByIds(eventIds);
                    }
                    
                    // Process trending videos and add to display
                    const processedVideos = trendingVideos.map(trending => {
                        const nostrVideo = allNostrVideos.find(v => v.id === trending.eventId);
                        if (nostrVideo) {
                            return {
                                ...nostrVideo,
                                trending: true,
                                views: trending.views || 0,
                                score: trending.score || 0
                            };
                        }
                        return null;
                    }).filter(Boolean);
                    
                    if (processedVideos.length > 0) {
                        console.log(`‚úÖ Found ${processedVideos.length} trending videos for #${category}`);
                        updateVideoGridWithTrending(processedVideos, category);
                        hideLoadingAnimation();
                        return;
                    }
                }
                
                // Fallback to local filtering if no trending data
                console.log(`üìù No trending data for #${category}, using local filtering`);
                filterByCategory(category);
                
            } catch (error) {
                console.error('‚ùå Error in analytics filtering:', error);
                // Fallback to original filtering
                filterByCategory(category);
            }
            
            hideLoadingAnimation();
        }

        // Fetch specific Nostr events by IDs
        async function fetchNostrEventsByIds(eventIds) {
            console.log(`üì• Fetching ${eventIds.length} specific events from Nostr`);
            
            try {
                const relayInstance = await initializeNostrRelay();
                if (!relayInstance) return;
                
                const filter = {
                    kinds: [22], // Videos only
                    ids: eventIds
                };
                
                return new Promise((resolve) => {
                    const sub = relayInstance.sub([filter]);
                    let receivedEvents = 0;
                    
                    sub.on('event', (event) => {
                        receivedEvents++;
                        const video = processNostrVideo(event);
                        if (video && !allNostrVideos.find(v => v.id === video.id)) {
                            allNostrVideos.push(video);
                            console.log(`üì¶ Added trending video: ${video.title || 'Untitled'}`);
                        }
                    });
                    
                    sub.on('eose', () => {
                        console.log(`‚úÖ Fetched ${receivedEvents} trending video events`);
                        sub.unsub();
                        resolve();
                    });
                    
                    setTimeout(() => {
                        sub.unsub();
                        resolve();
                    }, 5000);
                });
                
            } catch (error) {
                console.error('‚ùå Error fetching events by IDs:', error);
            }
        }

        // Update video grid with trending videos
        function updateVideoGridWithTrending(trendingVideos, category) {
            const grid = document.getElementById('vine-video-grid');
            if (!grid) return;
            
            grid.innerHTML = trendingVideos.map(video => `
                <div class="vine-grid-item ${video.trending ? 'trending' : ''}" onclick="watchVideo('${video.url}')" oncontextmenu="event.preventDefault(); showVideoOptions('${video.id}')">
                    <div class="vine-grid-thumbnail">
                        <video 
                            src="${video.url}" 
                            poster="${video.thumbnail || ''}"
                            preload="metadata" 
                            muted 
                            loop
                            onloadedmetadata="this.currentTime = 1"
                            onmouseover="this.play()" 
                            onmouseout="this.pause()">
                        </video>
                        ${video.trending ? '<div class="trending-badge">üî• Trending</div>' : ''}
                    </div>
                    <div class="vine-grid-overlay">
                        <div class="vine-grid-avatar" style="width: 20px; height: 20px; font-size: 10px;">${video.avatar}</div>
                        <span style="font-size: 11px; color: #333;">${video.username}</span>
                        <!-- Engagement metrics hidden until real data available -->
                    </div>
                </div>
            `).join('');
            
            // Update category header
            updateCategoryHeader(`#${category}`, trendingVideos.length);
        }
        
        // Helper function to update category header
        function updateCategoryHeader(category, count) {
            const header = document.querySelector('.vine-main-content h2');
            if (header) {
                header.textContent = `${category} (${count} trending)`;
            }
        }

        // Add a "Rising Videos" section to showcase velocity videos
        async function showRisingVideos() {
            console.log('üöÄ Loading rapidly rising videos...');
            showLoadingAnimation();
            
            try {
                const velocityVideos = await getVelocityVideos();
                
                if (velocityVideos.length > 0) {
                    // Fetch Nostr events for velocity videos
                    const eventIds = velocityVideos.map(v => v.eventId).filter(Boolean);
                    if (eventIds.length > 0) {
                        await fetchNostrEventsByIds(eventIds);
                    }
                    
                    // Process velocity videos
                    const processedVideos = velocityVideos.map(velocity => {
                        const nostrVideo = allNostrVideos.find(v => v.id === velocity.eventId);
                        if (nostrVideo) {
                            return {
                                ...nostrVideo,
                                trending: true,
                                velocity: true,
                                views: velocity.views || 0,
                                score: velocity.score || 0
                            };
                        }
                        return null;
                    }).filter(Boolean);
                    
                    if (processedVideos.length > 0) {
                        console.log(`‚úÖ Found ${processedVideos.length} rising videos`);
                        updateVideoGridWithRising(processedVideos);
                        hideLoadingAnimation();
                        return;
                    }
                }
                
                console.log('üìù No rising videos found');
                hideLoadingAnimation();
                
            } catch (error) {
                console.error('‚ùå Error loading rising videos:', error);
                hideLoadingAnimation();
            }
        }

        // Update video grid with rising videos
        function updateVideoGridWithRising(risingVideos) {
            const grid = document.getElementById('vine-video-grid');
            if (!grid) return;
            
            grid.innerHTML = risingVideos.map(video => `
                <div class="vine-grid-item trending" onclick="watchVideo('${video.url}')" oncontextmenu="event.preventDefault(); showVideoOptions('${video.id}')">
                    <div class="vine-grid-thumbnail">
                        <video 
                            src="${video.url}" 
                            poster="${video.thumbnail || ''}"
                            preload="metadata" 
                            muted 
                            loop
                            onloadedmetadata="this.currentTime = 1"
                            onmouseover="this.play()" 
                            onmouseout="this.pause()">
                        </video>
                        <div class="trending-badge">üöÄ Rising</div>
                    </div>
                    <div class="vine-grid-overlay">
                        <div class="vine-grid-avatar" style="width: 20px; height: 20px; font-size: 10px;">${video.avatar}</div>
                        <span style="font-size: 11px; color: #333;">${video.username}</span>
                        <!-- Engagement metrics hidden until real data available -->
                    </div>
                </div>
            `).join('');
            
            updateCategoryHeader('üöÄ Rising Videos', risingVideos.length);
        }

        // Load trending hashtags on page load
        window.addEventListener('DOMContentLoaded', async () => {
            // Load trending hashtags and update UI
            setTimeout(async () => {
                const trendingHashtags = await getTrendingHashtags();
                if (trendingHashtags.length > 0) {
                    console.log('üìä Updated trending hashtags:', trendingHashtags.slice(0, 5));
                    // Could update category section with trending tags
                }
            }, 2000); // Wait for initial content to load
        });

        // Make rising videos function available globally
        window.showRisingVideos = showRisingVideos;
    </script>
    <script src="vine-integration.js?v=1"></script>

    <footer>
        <div class="footer-content">
            <p>Made with üíö by <a href="https://rabblelabs.com" target="_blank">Rabble Labs</a> | 
            Built on <a href="https://nostr.com" target="_blank">Nostr Protocol</a> | 
            <a href="about.html">About OpenVine</a> | 
            <a href="privacy.html">Privacy Policy</a> | 
            <a href="https://github.com/rabble/nostrvine" target="_blank">Source Code</a></p>
            <p class="footer-mission">üå± Liberating Vine, one loop at a time | Building a social media ecosystem where users have <a href="https://rights.social" target="_blank">rights</a></p>
        </div>
    </footer>
</body>
</html>